---
output: html_document
bibliography: mi_bib.bib  
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("dplyr")    
setwd("C:/Users/nicom/Downloads/Informe-LET/datos")
library("openxlsx")
library("corrplot")
library("MASS")
library("kableExtra")
library("car")

Data = read.xlsx('SMM.xlsx')
Data$BCU10 = Data$BCU10E
DF = na.omit(Data)
DF$TASA_HIP = NULL
DF$AÑO = NULL
DF$MES = NULL
DF$BCU10E = NULL
#head(DF)
attach(DF)
```

# Metodología

En la literatura suele referirse a los prepagos mediante un indicador denominado
Conditional Prepayment Rate (${CPR}_t$) que surge de anualizar\footnote{Se realizan los cálculos asumiendo que la cantidad obtenida en el mes observado será constante para todos los meses del año.} la tasa de prepago observada en el mes $t$, denominada Single Monthly Mortality Rate (${SMM}_t$):
$${SMM}_t = \frac{\sum^{n}_{i=1}{Prepago}_{it}}{\sum^{n}_{i=1}{({Saldo}_{it} - {Amortización}_{it})}}$$
donde $n$ representa el número de préstamos vigentes en el mes $t$, ${Prepago}_{it}$ el
monto pre-pagado (total o parcial) por cada crédito, ${Saldo}_{it}$ el saldo de deuda al
inicio del mes y ${Amortización}_{it}$ la amortización (parte ya pagada de la deuda) programada para dicho período. La anualización de la SMM se obtiene de la siguiente expresión:
$${CPR}_t = 1 - (1-{SMM}_t)^{12}$$
Las series históricas de prepagos pueden ser explicadas también por factores exógenos, como variables financieras y macro-económicas. En el presente informe se ajustarán distintos modelos lineales para el $SMM$ mensual (elaborados por tanteo a partir del primero, en torno a las características que se detallarán), con el objetivo de comparar características que se detallarán más adelante.
A continuación, se definirán algunos conceptos clave para el correcto entendimiento del trabajo aquí presentado (En caso de que la lectora -o el lector- cuente con conocimientos de estadística, se aconseja avanzar directamente a la siguiente sección):

+ *Modelo lineal*: Sea una $Y$ una cantidad cuyo comportamiento aleatorio se desea estudiar (*variable respuesta*) con la finalidad o bien de predecir futuros valores o bien de estudiar su relación con otras ciertas cantidades $X_1, X_2, ..., X_n$ (éstas recibirán el nombre de *regresores*). Un modelo lineal en sus términos más simples consiste en proponer un cierto comportamiento de las variables en términos de distribuciones estadísticas (generalmente Normal) mediante establecer las siguientes condiciones:
$$Y = \beta_0 + \beta_1X_1 + \beta_2X_2 + \cdots +  + \beta_nX_n + \epsilon$$
$$\epsilon \sim N(0,1)$$
Donde los términos $\beta_k$ reciben el nombre de *coeficientes de regresión*, con $\beta_0$ siendo el *intercepto*, un término independiente que se interpreta como un coeficiente de intersección. 
Para más detalles sobre los fundamentos teóricos de los modelos lineales, se recomienda consultar el capítulo 3 del libro "Statistical Inference" por @tCAS90a.

+ *Significancia*: Definida para cada variable predictora considerada en un modelo, se dice que ésta es significativa si su *valor-p* es menor al nivel de significación previamente establecido (en el presente informe se considerará el valor $\alpha 0.05$ por es el más ampliamente utilizado). Una posible interpretación es que si una variable **no** es sifnificativa, entonces su efecto sobre la respuesta es trivial y no será necesario de considerar. Para efectos de comparación, se evaluará para cada modelo una métrica llamada N.S. (No Significativas) que contabiliza la proporción de variables consideradas en el modelo que según este criterio no significan un aporte. 

+ Calidad de ajuste: También llamada en la literatura como *bondad* de ajuste, es una medida de cuán bien funciona el modelo para predecir los valores de la respuesta. Se suelen usar algunas métricas estándar, en el presente informe se considerarán $R^2$, $R^2_{ajustado}$ y $AIC$.

+ Multi-colinealidad: En términos estadísticos se define como una medida de dependencia lineal entre variables predictoras. Para el lector no especializado se ofrece la siguiente interpretación: Si bien cada factor exógeno contribuye con información sobre el índice $SMM$, en caso de que algunos de ellos dependan de otros, habrá información redundante, lo cual dificultará el correcto funcionamiento del modelo. Para evaluar la multicolinealidad en un modelo se utiliza una métrica llamada $VIF$ (*variance inflation factor* por sus siglas en inglés) la cual al calcularse para cada factor, indicará que existe un problema de m.c. si su valor es mayor a $10$ (por convención).


# Variables predictoras: información
Tomando como referencia lo realizado en @saito2018mortgage, se recopiló información macro-economica desde el Banco Central de Chile (BC)\footnote{https://www.bcentral.cl} y de la Comisión para el Mercado Financiero de Chile (CMF)\footnote{ http://www.cmfchile.cl}. Se descargaron las series en formato excel y se empastaron a la base de datos sin cambios.

+ SMM: Datos correspondientes al índice calculado mensualmente entre los años 2003-2019.

+ BCU10: Bonos bullet emitidos por el banco central a plazos de 10 años. Información extraída desde el banco central.
    
+ IMACEC: Índice mensual de actividad económica, ponderación de ciertos indicadores con la participación de distintas actividades económicas en el PIB del año anterior. Información extraída desde el banco central.
    
+ Tasa de Desempleo: Tasa nacional de desocupación entregada por el INE mediante la Encuesta Nacional de Empleo (ENE). Información extraída desde la CMF.
    
+ Tasa de Interés Interbancaria (TIB):Tasa promedio ponderada diaria de préstamos de reservas bancarias entre bancos, sin colateral. Extraída desde CMF.
    
+ Tasa de Mercado (TM): Promedio del costo porcentual de captación de los recursos durante el año, más los puntos porcentuales que corresponden a los costos de operación de las instituciones financieras. Extraída desde CMF.
    
+ PIB: Producto Interno Bruto, valor total de los bienes y servicios finales (esto es, obtenidos por el consumidor final) producidos por el país, se obtiene a partir de la agregación temporal del IMACEC desestacionalizado. Extraído desde BC.

+ *Variables dummy*: También llamadas variables indicatrices, reciben esta denominación aquellas variables cuyo valor se fija en cero salvo en aquellos casos en que se cumple una condición previamente definida. En este contexto, se construyeron variables dummy indicando los meses del año, puesto que como se señala en el texto citado anteriormente, el mes del año también es una variable a considerar.


Adicionalmente, se aprecia en la figura 1 una representación gráfica de la matriz correlaciones entre las distintas variables incluyendo la variable respuesta, donde rojo y azul corresponden a $-1$ y $1$ respectivamente. Los colores de las celdas de la diagonal principal fueron retirados intencionalmente para no dificultar visualmente las comparaciones.

```{r, echo = F}
cors = cor(DF[,c("SMM","DESEMPLEO","IMACEC","BCU10","PIB","TM","Interbancaria")])
corrplot(cors, diag = F, method = "square")
```

A simple vista se aprecia poca correlación entre la variable objetivo (SMM) y las demás variables disponibles. No obstante, en la práctica es frecuente considerar que una correlación es alta si es mayor o igual a 0.5, por lo que no es del todo útil la comparación con otras parejas de variables con correlaciones muy altas. De hecho, podría resultar ser una situación indeseable: Nótese algunas correlaciones más potentes entre regresores como IMACEC y PIB, si bien es esperable dicho resultado tratándose de variables macroeconómicas, advierten sobre un posible problema de multi-colinealidad entre ellas.

# Proposición de modelos
La discusión anterior recibe el nombre de *análisis exploratorio*, y sirve como base para proponer posibles modelos. En este trabajo se propone un total de 5 modelos lineales distintos, construidos como se indica en la siguiente tabla:

| |Regresores incluidos (según modelo)|
|--|:---------------------:|
|1.| Todas las variables disponibles y además $\beta_0$|
|2.| Se retiraron los meses no significativos respecto al primer modelo|
|3.| TM, BCU10, los indicadores para todos los meses y además $\beta_0$|
|4.| TM, BCU10, sólo indicadores mensuales de ENE, ABR, MAY, JUL, AGO, OCT, NOV, DIC y además $\beta_0$|
|5.| TM, BCU10, sólo indicadores mensuales de ENE, ABR, MAY, JUL, AGO, OCT, NOV y además $\beta_0$|


El procedimiento para la confección de los distintos modelos será el siguiente: Se construyó el primer modelo sin descartar ningún tipo de información. Para el segundo modelo se descartaron las variables indicadoras mensuales que no resultaron significativas así como el intercepto. Para el tercero se hizo lo mismo pero sólo con las variables que no corresponden a meses ni al intercepto. Para el cuarto modelo se hicieron ambas cosas sobre el primer modelo, dejándose el intercepto, en éste último el indicador correspondiente al doceavo mes no resulta significativo, por lo que se hizo un quinto modelo el cual consiste en retirar ésta variable tomando el cuarto como base.
A continuación se presentan las métricas calculadas para cada modelo a partir de haberse instanciado mediante el software estadístico *R* con el método `lm()` (@package).

```{r, eval = F, include=FALSE}
R2 = c(0.3933645,0.380628,0.3790695,0.3499093,0.3498966),
R2aj = c(0.3255171,0.3246847,0.3273253,0.3090231,0.3133283),
AIC = c(-1533.502,-1535.97,-1537.542,-1535.741,-1537.737),
NS = c("12/18", "6/15", "4/14", "1/11", "0/10")
```

```{r, echo=FALSE}
library("kableExtra")
text_tbl <- data.frame(
Modelo = c("(1)", "(2)", "(3)",  "(4)", "(5)"),
R2 = c("39.33%","38.06%","37.90%","34.99%","34.98%"),
R2aj = c("32.55%","32.46%","32.73%","30.90%","31.33%"),
AIC = c(-1533.502,-1535.97,-1537.542,-1535.741,-1537.737),
NS = c("12/18", "6/15", "4/14", "1/11", "0/10")
)
kable(text_tbl, "html", booktabs = T, linesep = "\\addlinespace",
      caption = "Métricas de bondad de ajuste"
      ) %>%
kable_styling(full_width = F) %>%
column_spec(1, bold = T, color = "red")

```

Se aprecia en la tabla que si bien el quinto modelo no marca un mejor ajuste bajo los criterios $R^2$ y $R_{aj}^2$, sí lo hace por el criterio $AIC$ además de ser el único modelo que no presenta regresores no significativos. Por éstas razones éste modelo es -por el momento- el candidato más fuerte. Ahora es obligación chequear si presenta problemas de colinealidad, ésto se hará con el método `VIF()` (@car).

```{r, results='hide'}
modelo = lm(SMM ~ 1 + BCU10 + TM + ENE + ABR + MAY + JUL + AGO + OCT + NOV, data = DF)
```

```{r}
vif(modelo)
```

Los regresores que generan problemas de colinealidad son `TM` y `BCU10`, nótese además que esto es consistente con lo mostrado en la matriz de correlaciones. Para solucionar el problema, se construye un nuevo modelo sólo retirando el regresor TM (la desición entre los dos regresores problemáticos es arbitraria, pues se concluye que las variables entregan casi la misma información) el cual es reemplazado por el PIB al ser la variable más inversamente correlacionada además de sumar interpretabilidad al modelo.

```{r}
modelo.nuevo = lm(SMM ~ 1 + BCU10 + PIB + ENE + ABR + MAY + JUL + AGO + OCT + NOV, data = DF)
vif(modelo.nuevo)
```

Al comparar este nuevo modelo con los preexistentes, se obtiene que sus métricas son: $R^2 = 35.15%$, $R_{aj}^2 = 31.5%$, $AIC = -1538.147$, NS: $0/11$. Junto con ser razonablemente cercanas a las del modelo elegido anteriormente -de hecho presenta mejor $R^2$ y AIC-, se aprecia que al aplicar nuevamente el análisis de colinealidad resulta no tener problemas de esta índole. Con todo lo anterior, se puede concluir que, en base a la información exógena recopilada y considerada para este trabajo, el último modelo propuesto es el más óptimo en términos de significancia de los regresores, información redundante y calidad de ajuste.


# Referencias