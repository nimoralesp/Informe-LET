---
date: "16-11-2021"
output: html_document
keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
#install.packages("openxlsx")
#install.packages("corrplot")
library("openxlsx")
library("corrplot")
Data = read.xlsx('SMM.xlsx')
Data$BCU10 = Data$BCU10E
DF = na.omit(Data)
DF$TASA_HIP = NULL
DF$AÑO = NULL
DF$MES = NULL
DF$BCU10E = NULL
#head(DF)
attach(DF)
```

# Metodología

En la literatura suele referirse a los prepagos mediante un indicador denominado
Conditional Prepayment Rate (${CPR}_t$) que surge de anualizar la tasa de prepago observada en el mes $t$, denominada Single Monthly Mortality Rate (${SMM}_t$):
$${SMM}_t = \frac{\sum^{n}_{i=1}{Prepago}_{it}}{\sum^{n}_{i=1}{({Saldo}_{it} - {Amortización}_{it})}}$$
donde $n$ representa el número de préstamos vigentes en el mes $t$, ${Prepago}_{it}$ el
monto pre-pagado (total o parcial) por cada crédito, ${Saldo}_{it}$ saldo de deuda al
inicio del mes y ${Amortización}_{it}$ la amortización programada dicho período. La anualización de la SMM se obtiene de la siguiente expresión:
$${CPR}_t = 1 - (1-{SMM}_t)^{12}$$
Las series históricas de prepagos, pueden ser explicadas también por factores exógenos como variables financieras y macro-económicas, pero la presencia de dependencia serial, hace recomendable la utilización de modelos
predictivos de series temporales, entre los más populares se encuentra el modelo \textbf{SARIMAX} (Seasonal Auto Regressive Integrated Moving Average eXogeneous
variables por sus siglas en inglés), que permite modelar series de tiempo no estacionarias, con estacionalidad, incorporando a su vez factores externos que pueden estar afectando el comportamiento de la serie.
La descripción matemática de un modelo SARIMAX$(p,d,q)\times {(P,D,Q)}_S$ es como sigue:
$$\varphi(B)\delta(B^S){(1-B)}^d{(1-B^S)}^D(Y_t - X_t\beta) = \theta(B)\vartheta(B^s)\varepsilon_t$$
Donde $Y_t$ es la serie a modelar, $B$ es un operador de rezago $BY_t = Y_{t-1}$, $X$ es una
matriz de regresores, $\beta$ es un vector de coeficientes, y $\varepsilon_t$ es una secuencia de errores no correlacionados. Los valores $d$ y $D$ corresponden al número de diferenciaciones necesarias para quitar efectos de tendencia y de estacionalidad, los cuales al considerar regresores son usualmente cero. Los valores $p$ y $q$ están asociados a la dependencia serial observada a la serie ajustada por los regresores. En el caso de detectar un patrón estacional $S$, se consideran además los valores $P$ y $Q$. Los polinomios asociados al modelo son:
\begin{eqnarray}
\varphi(B) = 1 + \varphi_1B + \dots + \varphi_pB^p\\
\delta(B^S) = 1 + \delta_1B^S + \dots + \delta_pB^{SP}\\
\theta(B) = 1 + \theta_1B + \dots + \theta_qB^q\\
\vartheta(B^s) = 1 + \vartheta_1B^S + \dots + \vartheta_QB^{SQ}
\nonumber
\end{eqnarray}
El ajuste de un modelo SARIMAX a los datos se realiza considerando varios aspectos relevantes. Por ejemplo, hay que especificar la estacionalidad $S$; la
diferenciación $d$, $D$; y los órdenes de rezago $p$, $P$, $q$, $Q$ para la serie de tiempo.
Usualmente esta especificación se lleva a cabo inspeccionando los gráficos de auto-correlaciones muestrales. Una vez determinados estos valores, se procede al cálculo de los estimadores para todos los coeficientes. Este paso se puede realizar en base a varios métodos de estimación, entre los que podemos mencionar el método de máxima verosimilitud o el método de momentos Yule-Walker. Una descripción detallada de estos y otros métodos de estimación puede encontrarse en los textos 
@Broc91 y @palma2016time.


# Información

Tomando como referencia lo realizado en @saito2018mortgage, se recopiló información macro-economica desde el Banco Central de Chile\footnote{https://www.bcentral.cl} y de la Comisión para el Mercado Financieron de Chile (CMF)\footnote{ http://www.cmfchile.cl}. 

```{r, echo=F}
head(DF)
```


+ BCU10: Bonos bullet emitidos por el banco central a plazos de 10 años.
    
+ IMACEC: Índice mensual de actividad económica, ponderación de ciertos indicadores con la participación de distintas actividades económicas en el PIB del año anterior.
    
+ Tasa de Desempleo: Tasa nacional de desocupación entregada por el INE mediante la Encuesta Nacional de Empleo (ENE).
    
+ Tasa de Interés Interbancaria (TIB):Tasa promedio ponderada diaria de préstamos de reservas bancarias entre bancos, sin colateral.
    
+ Tasa de Mercado (TM): Promedio del costo porcentual de captación de los recursos durante el año, más los puntos porcentuales que corresponden a los costos de operación de las instituciones financieras.
    
+ PIB: Producto Interno Bruto, valor total de los bienes y servicios finales (esto es, obtenidos por el consumidor final) producidos por el país, se obtiene a partir de la agregación temporal del IMACEC desestacionalizado.

Con estas información se procedió a modelar la tasa de prepago de créditos hipotecarios en un banco de la plaza.

# Modelo

## Análisis de correlación

Se realizó un análisis de correlación entre las variables disponibles. La figura \ref{fig:corrplot} se muestra una representación gráfica de la matriz de correlaciones, donde rojo y azul corresponden a $-1$ y $1$ respectivamente.

```{r, echo = F}
cors = cor(DF[,c("SMM","DESEMPLEO","IMACEC","BCU10","PIB","TM","Interbancaria")])
corrplot(cors, type = "lower", diag = F,  cl.pos = "n", method = "square")
```

Nótese en primer lugar que existe poca correlación entre la variable objetivo (SMM) y las demás variables disponibles. En segundo lugar, es necesario poner atención a algunas correlaciones muy potentes entre regresores (como IMACEC y PIB), lo cual si bien es esperable tratándose de variables macroeconómicas, advierten sobre un posible problema de multicolinealidad entre ellas. 